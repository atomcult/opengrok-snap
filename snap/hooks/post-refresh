#!/bin/bash

hook_name="$(basename $0)"
logger "hook: ${hook_name}: hook start"

# run common part of the hook
${SNAP}/bin/snap-hooks-common

# clean ssh-agent.socket
[ -e ${SNAP_DATA}/ssh-agent.socket ] && rm ${SNAP_DATA}/ssh-agent.socket

# upgrading OpenGrok often corrupts indexed history,
# as precaution automatically rebuild index is feature is enabled
# and opengrok version has changed
if [ "$(snapctl get opengrok.auto-rebuild-index)" = "ON" ]; then
  if [ "${SNAP_VERSION}" = "$(snapctl get last-opengrok-version=)" ];then
    logger "rebuilding index..."
    snapctl start ${SNAP_INSTANCE_NAME}.rebuild-index-helper &
    snapctl unset last-opengrok-version
  fi
fi
